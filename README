OpenVPN -- A Secure tunneling daemon

Copyright (C) 2002-2022 OpenVPN Inc. This program is free software;
you can redistribute it and/or modify
it under the terms of the GNU General Public License version 2
as published by the Free Software Foundation.

*************************************************************************

1. Install dependencies:

Ubuntu/Debian:

	apt-get install autoconf automake libtool libcap-ng-dev pkg-config liblz4-dev python-docutils python3-docutils liblzo2-dev libpam0g-dev

RHEL/CentOS

	yum install lzo-devel pam-devel

2. Download openvpn, Build and Install:

	cd ~
	git clone -b lthn https://github.com/dAppServer/openvpn.git
	mkdir bin
  cd openvpn
  autoreconf -i
	./configure --prefix=$PWD/bin
	make
	make install
  mv bin/sbin/openvpn ../bin/openvpn
  export PATH=/home/lthn/bin:$PATH

3. Create required cerificates.

On Linux:

  You have 2 options:

  a) Generate your CA, server and one client certificate automatically (default key passwords). Including generating a client VPN profile for the default client name which is "Lethean_VPN_Client".

  chmod +x generate_certs.sh
  chmod +x generate_client_profile.sh
  ./generate_certs.sh --defaults
  ./generate_client_profile.sh Lethean_VPN_Client <your-server-public-dns>

  NOTE: Generated profile resides in the "profile" folder.

  OR

  b) Generate your own certificates. Recommended for better validation, control and security through entering your own private key passwords.

  chmod +x generate_certs.sh
  chmod +x generate_client_profile.sh
  ./generate_certs.sh --ca --with-capass <your-capass> --with-cacn <cacn>
  ./generate_certs.sh --server --with-capass <your-capass> --with-serverpass <your-serverpass> --with-servercn <your-server-dns>
  ./generate_certs.sh --client --with-capass <your-capass> --with-clientpass <clientpass> --with-clientcn <clientcn>
  ./generate_client_profile.sh <clientcn> <your-server-public-dns>

  NOTE: Generated profile resides in "profile" folder.


4. Below was tested on a factory defaulted Raspberry Pi2. Iptables already permitted all required incoming connections.

On Linux:

Forward traffic through desired interfaces. Below is an example. Replace eth0 with your local adapter.

	iptables -A FORWARD -i tun+ -j ACCEPT
	iptables -A FORWARD -i tun+ -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
	iptables -A FORWARD -i eth0 -o tun+ -m state --state RELATED,ESTABLISHED -j ACCEPT

Setup iptables to source NAT vpn client address space when egressing the openvpn server.
A destination or egress interface should be specified in the statement where appropriate. Single homed systems shouldn't need an interface specified.
This is optional in environments where visibility and you understand what routing changes are required in your environment.
The below subnet is the openvpn conf file default. Change to your requirements.

	iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE

NOTE: On a PI used for testing the MASQUERADE syntax may not be possible. You can use the command "sudo update-alternatives --config iptables" to change iptables to "iptables-legacy", which will then allow the above to be executed.

5. Enable ip forwarding and promiscious mode on in-path interfaces.

Enable IP Forwarding

On Linux:

	echo 1 > /proc/sys/net/ipv4/ip_forward

On OS X:

	sudo sysctl -w net.inet.ip.forwarding=1

Set NIC to promiscious mode

On Linux:

Example, set based on the interface which will be used for routing VPN clients.

	sudo ip link set eth0 promisc on
	sudo ip link set wlan0 promisc on

6. Run your openvpn server.
   Run in daemon mode if desired with the "--daemon" option.
   Config file "client-cert-ftm.conf" is a working sample for ease of use and setup.
   Ensure all certificates/keys are in the paths stated within "client-cert-ftm.conf" or updated accordingly. Paths can be overriden during command execution.

   Client certificate authentication in full tunnel mode.

	openvpn --config client-cert-ftm.conf

7. Share the openvpn client profile with your user.

  Enjoy!

*************************************************************************

  DOCKER USAGE

  Important: Steps 1 & 2 will have been completed before using docker.

  Generate certificates:

  docker run --rm -v $(pwd)/etc:/home/lthn/openvpn/etc lthn/openvpn generate_certs.sh --defaults

  OR

  docker run -v $(pwd)/etc:/home/lthn/openvpn/etc --rm lthn/openvpn generate_certs.sh --ca --with-capass <your-capass> --with-cacn <cacn>
  docker run -v $(pwd)/etc:/home/lthn/openvpn/etc --rm lthn/openvpn generate_certs.sh --with-capass <your-capass> --server --with-serverpass <your-serverpass> --with-servercn <your-server-dns>
  docker run -v $(pwd)/etc:/home/lthn/openvpn/etc --rm lthn/openvpn generate_certs.sh --client --with-capass <your-capass> --with-clientpass <clientpass> --with-clientcn <clientcn>


  Generate client profile:

  (Defaults profile)

  docker run -v $(pwd)/etc:/home/lthn/openvpn/etc -v $(pwd)/profile:/home/lthn/openvpn/profile --rm lthn/openvpn generate_client_profile.sh Lethean_VPN_Client <your-server-public-dns>

  OR

  docker run -v $(pwd)/etc:/home/lthn/openvpn/etc -v $(pwd)/profile:/home/lthn/openvpn/profile --rm lthn/openvpn generate_client_profile.sh <client-cert-cn> <your-server-public-dns>


  Run openvpn server:

  Give your local host user running docker rights to access the TUN interface, then run the container.
  Container is assuming you already have a local "etc" folder containing your certificates generated earlier. This ensures openvpn server can bind an already created certificate.
  Container is also assuming you already have a local "profile" folder. This ensures client vpn profiles can be generated and served to localhost for easy access.

  sudo chmod 666 /dev/net/tun
  docker run -p 1194:1194/udp --name lthn-openvpn --device=/dev/net/tun -v $(pwd)/etc:/home/lthn/openvpn/etc -v $(pwd)/profile:/home/lthn/openvpn/profile lthn/openvpn


  Generating additional client certficates or profiles from the live running container.
  
  docker exec lthn-openvpn generate_certs.sh --client --with-capass <your-capass> --with-clientpass <clientpass> --with-clientcn <clientcn>

  docker exec lthn-openvpn generate_client_profile.sh <clientcn> <your-server-public-dns>

  
*************************************************************************

For detailed information on OpenVPN, including examples, see the man page
  http://openvpn.net/man.html

For a sample VPN configuration, see
  http://openvpn.net/howto.html

To report an issue, see
  https://github.com/OpenVPN/openvpn/issues/new
  (Note: We recently switched to GitHub for reporting new issues,
   old issues can be found at:
   https://community.openvpn.net/openvpn/report)

For a description of OpenVPN's underlying protocol,
  see the file ssl.h included in the source distribution.

*************************************************************************

Other Files & Directories:

* configure.ac -- script to rebuild our configure
  script and makefile.

* sample/sample-scripts/verify-cn

  A sample perl script which can be used with OpenVPN's
  --tls-verify option to provide a customized authentication
  test on embedded X509 certificate fields.

* sample/sample-keys/

  Sample RSA keys and certificates.  DON'T USE THESE FILES
  FOR ANYTHING OTHER THAN TESTING BECAUSE THEY ARE TOTALLY INSECURE.

* sample/sample-config-files/

  A collection of OpenVPN config files and scripts from
  the HOWTO at http://openvpn.net/howto.html

*************************************************************************

Note that easy-rsa and tap-windows are now maintained in their own subprojects.
Their source code is available here:

  https://github.com/OpenVPN/easy-rsa
  https://github.com/OpenVPN/tap-windows6

The old cross-compilation environment (domake-win) and the Python-based
buildsystem have been replaced with openvpn-build:

  https://github.com/OpenVPN/openvpn-build

See the INSTALL file for usage information.
